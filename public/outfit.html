<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outfits | pttp</title>
    <link rel="icon" href="assets/icon.png" type="image/png">
    <!-- Load Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="config.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bai+Jamjuree:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;1,200;1,300;1,400;1,500;1,600;1,700&display=swap');

        /* Set default font to Inter */
        html {
            scroll-behavior: smooth;
        }

        /* Basic dark mode setup for demonstration */
        body {
            @apply bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100;
        }
    </style>
    <script>
        // Use a toggle state to simulate dark mode for demonstration
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'primary': {
                            500: '#6366f1',
                            600: '#4f46e5',
                        },
                    },
                    fontFamily: {
                        sans: ['Bai Jamjuree', 'sans-serif'],
                    }
                }
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (prefersDark) {
                document.documentElement.classList.add('dark');
            }
        });
    </script>
</head>
<body>

    <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12" id="outfits">
        <div class="mb-8 text-center">
            <h2 class="text-4xl font-extrabold text-gray-900 dark:text-gray-50">Outfits</h2>
        </div>
        
        <!-- The grid container now uses responsive Tailwind classes -->
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6" id="outfits-all">
            <!-- Content will be injected here by JavaScript -->
        </div>
    </section>

    <script>
    // ---------- Utility helpers ----------
    const byId = id => document.getElementById(id);
    const safe = v => v === undefined || v === null ? '' : v;

    function mapToObjects(rows, keys) {
        if (!Array.isArray(rows)) return [];
        return rows.map(r => {
            const obj = {};
            keys.forEach((k, i) => obj[k] = r[i] || '');
            return obj;
        }).filter(o => Object.values(o).some(v => v !== ''));
    }

    // ---------- RENDERERS (use your original templates, converted to functions) ----------
    // Outfit
    function renderOutfit(rows) {
        const container = byId('outfits-all');
        if (!container) return;
        const keys = ['date', 'time', 'artist', 'title', 'location', 'info', 'img', 'link', 'outfit', 'keyword', 'tag', 'note', 'keylink', 'taglink', 'dateformat'];
        const items = mapToObjects(rows, keys);
        container.innerHTML = items.map(it => `
            ${safe(it.outfit) ? `
                <div class="group outfits-card relative bg-white dark:bg-gray-800 rounded-xl shadow-xl transition duration-300 ease-in-out hover:shadow-primary-500/50 transform hover:-translate-y-1 overflow-hidden">
                    <!-- Aspect Ratio Container (1:1) -->
                    <div class="w-full aspect-square overflow-hidden">
                        <img 
                            src="${safe(it.outfit)}" 
                            alt="Outfit Visual" 
                            class="w-full h-full object-cover object-center transition duration-500 group-hover:scale-[1.05] transform"
                            loading="lazy"
                            onclick="openPopup(['${safe(it.outfit)}'])"
                        />
                    </div>
                    
                    <!-- Outfit Details Overlay/Footer -->
                    <div class="p-3">
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1 text-center">
                            ${safe(it.dateformat) || 'Date Unknown'}
                        </p>
                        <p class="outfits-tags text-center">
                            <a href="${safe(it.tag) ? safe(it.taglink) : safe(it.keylink)}" target="_blank" rel="noopener noreferrer" class="
                                inline-block px-3 py-1 text-xs font-bold rounded-full 
                                bg-primary-500/10 text-primary-600 
                                hover:bg-primary-500/20 
                                dark:text-primary-400 dark:hover:bg-primary-500/30
                                transition duration-200
                            ">
                                ${safe(it.tag) || safe(it.keyword)}
                            </a>
                        </p>
                    </div>
                </div>
            ` : ''}
        `).join('');
        lucide.createIcons();
    }

    // Popup image/video viewer
    let popupIndex = 0;
    let popupItems = [];
    function openPopup(items, start=0) {
        popupItems = items || [];
        popupIndex = start || 0;
        const popup = byId('popup');
        if (!popup) return;
        const img = byId('popup-img');
        const video = byId('popup-video');
        const source = byId('video-source');

        const current = popupItems[popupIndex] || '';
        if (current.match(/\.(mp4|webm|ogg)$/i)) {
            img.style.display = 'none';
            video.style.display = 'block';
            source.src = current;
            video.load();
        } else {
            video.style.display = 'none';
            img.style.display = 'block';
            img.src = current;
        }
        popup.style.display = 'flex';
    }
    function closePopup() {
        const popup = byId('popup');
        if (!popup) return;
        const video = byId('popup-video');
        if (video) { video.pause(); video.currentTime = 0; }
        popup.style.display = 'none';
    }
    function prevMedia() {
        if (!popupItems.length) return;
        popupIndex = (popupIndex - 1 + popupItems.length) % popupItems.length;
        openPopup(popupItems, popupIndex);
    }
    function nextMedia() {
        if (!popupItems.length) return;
        popupIndex = (popupIndex + 1) % popupItems.length;
        openPopup(popupItems, popupIndex);
    }
    window.openPopup = openPopup;
    window.closePopup = closePopup;
    window.prevMedia = prevMedia;
    window.nextMedia = nextMedia;

    // Utility to open external links
    function openLink(url) { if (!url) return; window.open(url, '_blank'); }
    window.openLink = openLink;

    // ---------- MAIN: fetch once and render ----------
    async function loadAllData() {
        try {
            // show small loading indicators where appropriate
            const outfits = byId('outfits-all'); if (outfits) outfits.innerHTML = `<p class="text-center col-span-full p-8 text-gray-600">loading data...</p>`;
            const res = await fetch('/api/all-data');
            if (!res.ok) throw new Error('Failed to fetch /api/all-data');
            const json = await res.json();

            // call individual renderers
            renderOutfit(json.outfit || []);

            // setup icons & misc
            lucide.createIcons();
            // ensure calendar listeners
            document.addEventListener('click', (e) => {
                const popup = byId('popup');
                if (e.target.id === 'popup') closePopup();
            });
            const closeModalBtn = byId('closeModalButton');
            closeModalBtn && closeModalBtn.addEventListener('click', closeModal);

        } catch (err) {
            console.error('loadAllData error', err);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        currentMonth.setDate(1);
        loadAllData();
    });

    </script>

    <div id="popup" class="popup" onclick="closePopup()">
        <div class="popup-content" onclick="event.stopPropagation()">
            <img id="popup-img" src="" alt="Full-size Event Image" onclick="closePopup()">
            <video id="popup-video" controls style="display: none; max-width: 100%; max-height: 100%;">
                <source id="video-source" src="" type="video/mp4">
                Your browser does not support the video tag.
            </video>
            <button class="nav-btn prev-btn" onclick="prevMedia()">❮</button>
            <button class="nav-btn next-btn" onclick="nextMedia()">❯</button>
        </div>
        <style>
            /* popup */
            #popup, .popup {
                display: none; /* Make sure to change to 'flex' when opening */
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.8);
                /* display: flex; */
                justify-content: center;
                align-items: center;
                z-index: 1000;
            }
            .popup-content {
                display: flex; /* Make it a flex container */
                flex-direction: column; /* Align items in a column */
                align-items: center; /* Center items horizontally */
                justify-content: center;
                height: 80%; /* Set a fixed height for the popup content */
                max-width: 90%; /* Adjust maximum width of the content */
                overflow: hidden; /* Hide overflow to avoid scrollbars */
            }
            .popup-content img {
                max-width: 100%; /* Ensure the image does not exceed the popup width */
                max-height: 100%; /* Ensure the image does not exceed the popup height */
                object-fit: contain; /* Maintain aspect ratio */
                cursor: pointer;
            }

            .nav-btn {
                position: absolute;
                top: 50%;
                transform: translateY(-50%);
                background-color: rgba(255, 255, 255, 0.7);
                border: none;
                font-size: 24px;
                color: #333;
                cursor: pointer;
                padding: 10px;
                border-radius: 50%;
            }
            .prev-btn {
                left: 10px;
            }

            .next-btn {
                right: 10px;
            }
        </style>
        <script>
            // popup
            let currentMediaIndex = 0;
            let mediaArray = [];

            function openPopup(media) {
                mediaArray = media; // Store the array of media
                currentMediaIndex = 0; // Reset the index
                showMedia(currentMediaIndex);
                document.getElementById("popup").style.display = "flex"; // Open the popup
            }

            function showMedia(index) {
                const imgElement = document.getElementById("popup-img");
                const videoElement = document.getElementById("popup-video");
                const videoSource = document.getElementById("video-source");
                const prevButton = document.querySelector('.prev-btn');
                const nextButton = document.querySelector('.next-btn');

                // Pause the video if it is playing
                videoElement.pause(); 
                videoElement.currentTime = 0; // Reset video time to start

                // Check if the current media is an image or a video
                if (mediaArray[index].endsWith('.mp4')) {
                    imgElement.style.display = "none"; // Hide image
                    videoElement.style.display = "block"; // Show video
                    videoSource.src = mediaArray[index];
                    videoElement.load(); // Load the video
                    videoElement.play(); // Automatically play video if desired
                } else {
                    imgElement.style.display = "block"; // Show image
                    videoElement.style.display = "none"; // Hide video
                    imgElement.src = mediaArray[index];
                }

                // Show or hide navigation buttons based on media count and current index
                prevButton.style.display = index === 0 ? "none" : "block"; // Hide previous button for the first media
                nextButton.style.display = index === mediaArray.length - 1 ? "none" : "block"; // Hide next button for the last media
            }

            function closePopup() {
                const videoElement = document.getElementById("popup-video");
                videoElement.pause(); // Pause the video if playing
                videoElement.currentTime = 0; // Reset video time to start
                document.getElementById("popup").style.display = "none"; // Close the popup
            }

            function prevMedia() {
                if (currentMediaIndex > 0) {
                    currentMediaIndex--;
                    showMedia(currentMediaIndex);
                }
            }

            function nextMedia() {
                if (currentMediaIndex < mediaArray.length - 1) {
                    currentMediaIndex++;
                    showMedia(currentMediaIndex);
                }
            }
        </script>
    </div>

</body>
</html>